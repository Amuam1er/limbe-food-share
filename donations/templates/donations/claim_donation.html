{% extends 'donations/base.html' %}

{% block title %}Claim {{ donation.title }} - Limbe Food Share{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- Donation Summary -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>You're about to claim:</h4>
                <h3 class="text-primary">{{ donation.title }}</h3>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <strong>Quantity:</strong> {{ donation.quantity }}<br>
                        <strong>Pickup:</strong> {{ donation.pickup_address }}<br>
                    </div>
                    <div class="col-md-6">
                        <strong>Expires:</strong> {{ donation.expiry_time|date:"M d, g:i A" }}<br>
                        <strong>Donor:</strong> {{ donation.donor_name }}
                    </div>
                </div>
            </div>
        </div>
        
        {% if active_claim %}
            <!-- Already Claimed Alert -->
            <div class="alert alert-warning">
                <h5>‚ö†Ô∏è This donation is currently claimed</h5>
                <p class="mb-2">
                    <strong>{{ active_claim.volunteer_name }}</strong> claimed this 
                    {{ active_claim.claimed_at|timesince }} ago.
                </p>
                
                {% if active_claim.status == 'pending' %}
                    <p class="mb-0">
                        They have a 5-minute hold. If you submit your info, you'll be added to the waitlist
                        and notified if the claim expires.
                    </p>
                {% else %}
                    <p class="mb-0">
                        This claim has been confirmed. You can still join the waitlist in case it falls through.
                    </p>
                {% endif %}
            </div>
        {% endif %}
        
        <!-- Claim Form -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    {% if active_claim %}Join Waitlist{% else %}Claim This Donation{% endif %}
                </h3>
            </div>
            <div class="card-body">
                {% if not active_claim %}
                    <div class="alert alert-info">
                        <strong>How it works:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Submit your contact info</li>
                            <li>You get a 5-minute hold on this donation</li>
                            <li>Donor receives your (masked) phone number</li>
                            <li>After 5 minutes, your full contact is revealed automatically</li>
                            <li>Coordinate pickup with the donor</li>
                        </ol>
                    </div>
                {% endif %}
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">{{ form.volunteer_name.label }}</label>
                        {{ form.volunteer_name }}
                        {% if form.volunteer_name.errors %}
                            <div class="text-danger small">{{ form.volunteer_name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ form.volunteer_phone.label }}</label>
                        {{ form.volunteer_phone }}
                        <small class="form-text text-muted">
                            The donor will contact you at this number
                        </small>
                        {% if form.volunteer_phone.errors %}
                            <div class="text-danger small">{{ form.volunteer_phone.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ form.volunteer_email.label }}</label>
                        {{ form.volunteer_email }}
                        {% if form.volunteer_email.errors %}
                            <div class="text-danger small">{{ form.volunteer_email.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            {% if active_claim %}
                                Join Waitlist
                            {% else %}
                                üôã Claim Donation (5-min hold)
                            {% endif %}
                        </button>
                        <a href="{% url 'donation_detail' donation.id %}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}